<!DOCTYPE html>
<html>
<head>
<style>
#content {
	margin: auto;
	width: 95%;
	padding: 10px;
	font-size: 5.25vw;
}

.center { text-align: center; }

@font-face {
  font-family: 'Versiculum';
  font-style: normal;
  font-weight: normal;
  src: url(data:application/font-woff;charset=utf-8;base64,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) format('woff');
}

v { font-family: 'Versiculum'; font-size:6.5vw; }

i { color: red; font-style: italic; }

r { color: red; }
</style>
<script src='./loth.js?uiid=104'></script>

<script src="yaml.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<title>Liturgy of the Hours</title>

<script>
	jQuery.ajaxSetup({async:false});
	var UUID='103';

	urlParams = new URLSearchParams(window.location.search);
	var today;

	if (urlParams.has('d')) {
	today = dayToDate([urlParams.get('m'),urlParams.get('d'),urlParams.get('y')]);
} else {

	today = new Date();
}
	console.log(today);

	var currentYear = today.getFullYear();

	var WEEKDAYS = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];

	var options = [];

	function getOptions(today, currentYear) {

	function getYaml(url, callback) {
		url = url + '?' + UUID;
		jQuery.get(url, function(data) {
			console.log('got ' + url);
			callback(YAML.parse(data));
		});
	}

	function offer(feast) {
		console.log('offer: ' + feast);
		options.push([today, feast[1], feast[0], feast[2]]);
	}

	function offerLink(link) {
		console.log('offer link: ' + link);
		getYaml('https://daniel.writefamily.com/liturgy/propers/'+link+'.yml',function(data){
			offer([data.rank, data.name, link]);
		});
	}

	function ordinaryTime() {
		var weekSundays = [];
		weekSundays[1] = getBaptism(currentYear);
		for (let i = 2; i <= 5; i++) {
			weekSundays[i] = moveDayForwardDays(weekSundays[i - 1], 7);
		}

		for (let i = 1; i < weekSundays.length; i++) weekSundays[i] = dayToDate(weekSundays[i]);

		var nextSunday = moveDateForwardDays(weekSundays[5], 7);
		var index = 6;
		while (nextSunday < dayToDate(getAshWednesday(currentYear))) {
			weekSundays[index++] = nextSunday;
			nextSunday = moveDateForwardDays(nextSunday, 7);
		}

		weekSundays[index++] = moveDateForwardDays(nextSunday, 2);

		var medialWeeks = [];
		medialWeeks[6] = [5, 8, currentYear];
		medialWeeks[7] = [5, 15, currentYear];
		medialWeeks[8] = [5, 22, currentYear];
		medialWeeks[9] = [5, 29, currentYear];

		for (let i = 6; i < 10; i++) medialWeeks[i] = dateToNextSunday(dayToDate(medialWeeks[i]));

		index = 6;
		while (nextSunday < dayToDate(getPentecost(currentYear))) {
			nextSunday = medialWeeks[index++];
			if (index > 9) break;
		}

		if (nextSunday < dayToDate(getPentecost(currentYear))) {
			index = 10; nextSunday = dateToNextSunday(dayToDate([6, 5, currentYear]));
			while (nextSunday < dayToDate(getPentecost(currentYear))) {
				nextSunday = moveDateForwardDays(nextSunday, 7);
				index++;
			}
			weekSundays[index] = nextSunday;
		} else {
			weekSundays[--index] = nextSunday;
		}

		for (index = index + 1; index < 35; index++) {
			weekSundays[index] = moveDateForwardDays(weekSundays[index - 1], 7);
		}

		var weekNumber;
		for (let i = 1; i < weekSundays.length; i++) {
			let a = weekSundays[i];
			let b = weekSundays[i + 1];
			if (today >= a && (today < b || b == null)) weekNumber = i;
		}

		console.log(weekNumber + " Week in Ordinary Time");
		offerLink('ot/'+weekNumber+'/'+WEEKDAYS[today.getDay()]);
	}

		if (today >= dayToDate(moveDayForwardDays(getAdventSunday(currentYear + 1), 0))) { // we are in the next liturgical year
			console.log("The calendar year is behind the liturgical year.");
			currentYear++;
		}

		var bounds = [getAdventSunday(currentYear), moveDayForwardDays(getAdventSunday(currentYear + 1), -1)];

		console.log("Liturgical year " + currentYear + " began " + bounds[0] + " and ends " + bounds[1]);
		console.log("Today is " + dateToDay(today));

		// we must find ourselves on the temporal and sanctoral cycles
		// for the temporal cycle, our lankmarks are Advent, Christmas, Ash Wednesday, Easter, and Pentecost. Between Christmas and Ash Wednesday is ordianry time and between Pentecost and Advent is ordinary time.
		var season;
		if (today >= dayToDate(getAdventSunday(currentYear)) && today < dayToDate(getChristmas(currentYear))) {
			season = 'advent';
		} else if (today >= dayToDate(getChristmas(currentYear)) && today <= dayToDate(getBaptism(currentYear))) {
			season = 'christmas';
		} else if (today >= dayToDate(getAshWednesday(currentYear)) && today < dayToDate(getEaster(currentYear))) {
			season = 'lent';
		} else if (today >= dayToDate(getEaster(currentYear)) && today <= dayToDate(getPentecost(currentYear))) {
			season = 'easter';
		} else if (today > dayToDate(getBaptism(currentYear)) && today < dayToDate(getAshWednesday(currentYear))) {
			season = 'pre-lent';
		} else if (today > dayToDate(getPentecost(currentYear)) && today < dayToDate(getAdventSunday(currentYear + 1))) {
			season = 'post-pentecost';
		}
		else {
			alert("liturgical season given as unknown value '"+season+"'");
		}

		switch (season) {
			case 'pre-lent':
			case 'post-pentecost': ordinaryTime(); break;
		}

		var months = ['january','february','march','april','june','july','august','september','october','november','december'];
		getYaml('propers/'+months[dateToDay(today)[0] - 2]+'/'+dateToDay(today)[1]+'.yml',function(data){
			for (let i = 0; i < data.feasts.length; i++) {
				//offer(months[dateToDay(today)[0] - 2]+'/'+data.feasts[i][2]);
				console.log('feast: ' + data.feasts[i]);
				data.feasts[i][2] = months[dateToDay(today)[0] - 2]+'/'+data.feasts[i][2];
				offer(data.feasts[i]);
			}
		});

		}

		$(document).ready(function(){
		getOptions(today,currentYear);
		getOptions(moveDateForwardDays(today, 1), currentYear);

		for (let i = 0; i < options.length; i++) {
			console.log(options[i]);
			if ((options[i][0].getTime() != today.getTime()) && (options[i][2] == 'sunday' || options[i][2] == 'solemnity')) { // include first vespers alone, no saints
				console.log('\tfirst vespers');
				$('#content').append('<h3>'+options[i][1]+'</h3>');
				$('#content').append('<a href="office.html?t='+options[i][3]+'&hour=vespers1&v=lessons">First Vespers</a>');
			}

			if (options[i][0].getTime() == today.getTime()) { // include all hours
				$('#content').append('<h3>'+options[i][1]+'</h3>');
				if (options[i][2] == 'sunday' || options[i][2] == 'solemnity') {
					//$('#content').append('<p href="office.html?t='+options[i][3]+'&hour=vigil">Midnight Vigil</p>');
					//$('#content').append('<p href="office.html?t='+options[i][3]+'&hour=lauds">Lauds</p>');
					$('#content').append('<a href="office.html?t='+options[i][3]+'&hour=vespers2">Second Vespers</a>');
				} else if (options[i][2] == 'feria') {
					//$('#content').append('<p href="office.html?t='+options[i][3]+'&hour=vigil">Midnight Vigil</p>');
					//$('#content').append('<p href="office.html?t='+options[i][3]+'&hour=lauds">Lauds</p>');
					if (today.getDay() != 6) $('#content').append('<a href="office.html?t='+options[i][3]+'&hour=vespers2">Vespers</a>');
				} else {
					//$('#content').append('<p href="office.html?t='+options[0][3]+'&hour=vigil&s='+options[i][3]+'">Midnight Vigil</p>');
					//$('#content').append('<p href="office.html?t='+options[0][3]+'&hour=lauds&s='+options[i][3]+'">Lauds</p>');
					$('#content').append('<a href="office.html?t='+options[0][3]+'&hour=vespers2&s='+options[i][3]+'">Vespers</a>');
				}
			}
		}

		let width = screen.width;
				if (0.01 * width > 18) { // compress font size
					document.getElementById("content").style.fontSize = "2vw";
					var glyphs = document.getElementsByTagName('v');
					for (let i = 0; i < glyphs.length; i++) {
						glyphs[i].style.fontSize = "2.5vw";
					}
				}
		});
</script>

</head>
<body>
<div id='content'>
	<div class='center'><h1>Liturgy of the Hours</h1></div>
	<hr/>
</div>
<hr/>
<a href='https://github.com/writedan/liturgy-webapp'>Github source code</a>
</body>
</html>
